<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Export PDF Statistik Emosi Ruangan</title>
    <link rel="icon" type="image/png" href="/img/emodetc.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f6f8ff; color: #1f2937; }
        .export-container { max-width: 800px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.07); padding: 32px 24px; }
        .export-header { text-align: center; margin-bottom: 24px; }
        .export-header h2 { margin: 0 0 8px 0; font-size: 2em; color: #4a6cf7; }
        .export-header p { color: #888; margin: 0; }
        .section-title { font-size: 1.2em; font-weight: bold; margin-top: 24px; margin-bottom: 12px; color: #4a6cf7; }
        .table th, .table td { font-size: 15px; }
        .footer { margin-top: 32px; text-align: center; color: #888; font-size: 13px; }
    </style>
</head>
<body>
<div class="export-container">
    <div class="export-header" style="position:relative;">
        <img src="/img/emodetc.png" alt="Logo EmoDetc" id="pdfExportLogo" style="position:absolute;top:24px;left:24px;width:140px;height:auto;z-index:10;" />
        <h2 style="margin-bottom:2px;">Aplikasi EmoDetc</h2>
        <div style="font-size:1.1em;color:#4a6cf7;font-weight:600;margin-bottom:4px;">Emotion Detection Chat</div>
        <hr style="border-top:2px solid #4a6cf7;width:60%;margin:16px auto 12px auto;">
        <div style="font-size:1.1em;font-weight:500;margin-bottom:2px;">Laporan Emosi Ruangan</div>
        <p id="exportRoomInfo" style="margin-bottom:0;">Kode Ruangan: <span id="exportRoomCode"></span></p>
        <button id="downloadPdfBtn" class="btn btn-primary btn-sm mt-2" style="float:right;"><i class="fa fa-download me-1"></i> Download PDF</button>
    </div>
    <div style="margin-bottom:18px;margin-top:10px;font-size:1em;color:#444;">
        Berikut adalah grafik dan persentase emosi yang terdeteksi pada ruangan ini:
    </div>
    <div id="exportChartSection">
        <canvas id="exportEmotionChart" height="120"></canvas>
    </div>
    <div id="exportAveragesSection" class="mt-4"></div>
    <div style="margin:18px 0 8px 0;font-size:1em;color:#444;">Berikut anggota yang berhubungan:</div>
    <div id="exportUserStatsSection" class="mt-4">
        <div class="section-title">Statistik Per User</div>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Nama</th>
                    <th>Emosi Dominan</th>
                    <th>Jumlah Pesan</th>
                    <th>Role</th>
                </tr>
            </thead>
            <tbody id="exportUserStatsList">
                <!-- Data user stats -->
            </tbody>
        </table>
    </div>
    <div style="margin:24px 0 0 0;font-size:1em;color:#444;">
        Dari laporan tersebut dapat disimpulkan:<br>
        <span id="exportConclusion" style="font-weight:bold;"></span>
    </div>
    <div class="footer">
        <div>Generated by EmoDetc | <span id="exportDate"></span></div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// Script ini hanya template, data diisi dari halaman utama sebelum export PDF
// Contoh: window.exportData = { stats, userStats, leaderId, messages, roomCode }
// Lalu renderChartExport(window.exportData)
async function fetchAndRenderExportData() {
    // Ambil kode room dari URL
    const urlParams = new URLSearchParams(window.location.search);
    let code = urlParams.get('code');
    if (!code) {
        // Coba ambil dari path (misal /leader/room/:code/export)
        const match = window.location.pathname.match(/room\/(.+)\/export/);
        if (match) code = match[1];
    }
    if (!code) return;
    try {
        const res = await fetch(`/leader/api/rooms/${code}/stats`);
        const data = await res.json();
        if (res.ok && data.success) {
            window.exportData = {
                stats: data.stats,
                userStats: data.userStats,
                leaderId: data.leaderId,
                messages: data.messages,
                roomCode: code
            };
            renderChartExport(window.exportData);
        }
    } catch (e) {}
}

function renderChartExport(data) {
    if (!data) return;
    document.getElementById('exportRoomCode').textContent = data.roomCode || '-';
    // Grafik garis emosi
    const ctx = document.getElementById('exportEmotionChart').getContext('2d');
    const emotions = ['happy', 'sad', 'angry', 'neutral'];
    const emotionLabels = { happy: 'Senang', sad: 'Sedih', angry: 'Marah', neutral: 'Netral' };
    const colors = { happy: '#22c55e', sad: '#3b82f6', angry: '#ef4444', neutral: '#a3a3a3' };
    const history = data.messages.map(msg => ({
        emotion: msg.emotion,
        timestamp: new Date(msg.created_at),
        timeString: new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
        username: msg.username
    }));
    const labels = history.map((entry, idx) => entry.timeString || (idx + 1).toString());
    const happyData = history.map(entry => entry.emotion === 'happy' ? 1 : 0);
    const sadData = history.map(entry => entry.emotion === 'sad' ? 1 : 0);
    const angryData = history.map(entry => entry.emotion === 'angry' ? 1 : 0);
    const neutralData = history.map(entry => entry.emotion === 'neutral' ? 1 : 0);
    if (labels.length > 0) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Senang', data: happyData, borderColor: colors.happy, backgroundColor: colors.happy, fill: false, tension: 0.2, pointRadius: 4 },
                    { label: 'Sedih', data: sadData, borderColor: colors.sad, backgroundColor: colors.sad, fill: false, tension: 0.2, pointRadius: 4 },
                    { label: 'Marah', data: angryData, borderColor: colors.angry, backgroundColor: colors.angry, fill: false, tension: 0.2, pointRadius: 4 },
                    { label: 'Netral', data: neutralData, borderColor: colors.neutral, backgroundColor: colors.neutral, fill: false, tension: 0.2, pointRadius: 4 }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: true } },
                scales: { y: { beginAtZero: true, title: { display: true, text: 'Jumlah Pesan' } }, x: { title: { display: true, text: 'Waktu/Jam' } } }
            }
        });
    }
    // Rata-rata emosi
    const counts = { happy: 0, sad: 0, angry: 0, neutral: 0 };
    const involved = { happy: new Set(), sad: new Set(), angry: new Set(), neutral: new Set() };
    history.forEach(h => {
        if (counts[h.emotion] !== undefined) counts[h.emotion]++;
        if (involved[h.emotion] && h.username) involved[h.emotion].add(h.username);
    });
    const totalMsg = history.length;
    let html = `<h5 class='mb-2'>Rata-rata Emosi</h5><div class='mb-2' style='color:#888'>Total pesan: ${totalMsg}</div>`;
    emotions.forEach(emotion => {
        const count = counts[emotion];
        const percent = totalMsg ? ((count / totalMsg) * 100).toFixed(1) : 0;
        const users = Array.from(involved[emotion] || []).map(name => `<span class='badge bg-light text-dark border me-1'>${name}</span>`);
        html += `
        <div style='margin-bottom:10px;'>
            <span style='font-weight:bold;color:${colors[emotion]};font-size:1.1em;'>${emotionLabels[emotion]}</span>
            <span style='float:right;font-weight:bold;color:${colors[emotion]}'>${percent}%</span>
            <div class='progress' style='height:8px;margin:6px 0 4px 0;'>
                <div class='progress-bar' style='width:${percent}%;background:${colors[emotion]}'></div>
            </div>
            <div style='font-size:13px;color:#888;'>${count} pesan &nbsp; User: ${users.length ? users.join('') : '-'}</div>
        </div>`;
    });
    document.getElementById('exportAveragesSection').innerHTML = html;
    // Tabel user stats
    const tbody = document.getElementById('exportUserStatsList');
    tbody.innerHTML = '';
    if (!data.userStats || data.userStats.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Belum ada data user.</td></tr>';
    } else {
        data.userStats.forEach((u, i) => {
            const isLeader = (data.leaderId && u.id === data.leaderId);
            const rowClass = isLeader ? 'table-warning' : '';
            tbody.innerHTML += `<tr class='${rowClass}'><td>${i+1}</td><td>${u.name}</td><td>${u.dominant_emotion || '-'}<\/td><td>${u.message_count || 0}</td><td>${isLeader ? '<span style=\"color:#d97706;font-weight:bold\">Leader</span>' : ''}</td></tr>`;
        });
    }
    // Kesimpulan dominasi emosi
    let maxEmotion = null, maxCount = 0;
    for (const emo of emotions) {
        if (counts[emo] > maxCount) {
            maxCount = counts[emo];
            maxEmotion = emo;
        }
    }
    let conclusion = '';
    if (maxEmotion) {
        conclusion = `bahwa <span style='color:${colors[maxEmotion]};font-weight:bold;'>Dominasi emosi yang ada di dalam ruangan ini adalah ${emotionLabels[maxEmotion]}</span>`;
    } else {
        conclusion = 'Tidak ada data emosi yang dapat disimpulkan.';
    }
    document.getElementById('exportConclusion').innerHTML = conclusion;
    document.getElementById('exportDate').textContent = new Date().toLocaleString();
}

// Otomatis fetch & render jika dibuka langsung
window.addEventListener('DOMContentLoaded', fetchAndRenderExportData);

// Tombol download PDF
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('downloadPdfBtn');
    if (btn) {
        btn.addEventListener('click', async function() {
            const logo = document.getElementById('pdfExportLogo');
            if (logo && !logo.complete) {
                await new Promise(resolve => {
                    logo.onload = resolve;
                    logo.onerror = resolve;
                });
            }
            const container = document.querySelector('.export-container');
            if (!container) return;
            btn.disabled = true;
            btn.textContent = 'Mengunduh...';
            await html2canvas(container, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new window.jspdf.jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
                const pageWidth = pdf.internal.pageSize.getWidth();
                const imgWidth = pageWidth - 40;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                pdf.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
                pdf.save('Laporan-Emosi-Ruangan.pdf');
            });
            btn.disabled = false;
            btn.textContent = 'Download PDF';
        });
    }
});
</script>
</script>
</body>
</html>
